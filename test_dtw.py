# -*- coding: utf-8 -*-
"""
Created on Mon Jan 11 19:02:11 2021

@author: allen
"""

import torch
import torch.nn as nn
import numpy as np
import new_dataloader


import trading_period_by_gate_mean_new
#import matrix_trading
import os 
import pandas as pd
import torch
import torch.utils.data as Data

import matplotlib.pyplot as plt
import time
path_to_image = "C:/Users/Allen/pair_trading DL/negative profit of 2018/"


path_to_average = "./2017/averageprice/"
ext_of_average = "_averagePrice_min.csv"
path_to_minprice = "./2017/minprice/"
ext_of_minprice = "_min_stock.csv"

path_to_2015compare = "./newstdcompare2015/" 
path_to_2016compare = "./newstdcompare2016/" 
path_to_2017compare = "./newstdcomparedtw2017/" 
path_to_2018compare = "./newstdcompare2018/" 
ext_of_compare = "_table.csv"

path_to_python ="C:/Users/Allen/pair_trading DL2"

path_to_half = "C:/Users/Allen/pair_trading DL2/2016/2016_half/"
path_to_2017half = "./2017_halfmin/"
path_to_2018half = "./2018_halfmin/"
ext_of_half = "_half_min.csv"

path_to_profit = "C:/Users/Allen/pair_trading DL2/New3_ResNet_2018/2015-201610mean_TT05(0.15)_nostop/"

max_posion = 5

def test_reward():
    total_reward = 0
    total_num = 0
    total_trade =[0,0,0]
    action_list=[]
    check = 0
    #actions =[[0.5000000000001013, 1.6058835588357105], [1.1231567674441643, 3.009226460170205], [1.6774656461992412, 8.482170812315225], [2.434225143491954, 5.0301795963708305], [3.838786213786223, 7.405844155844149], [50, 100]]
    #actions =[[0.5000000000001013, 1.6058835588357105], [0.8422529644270367, 2.7302766798420457], [1.42874957000333, 3.312693498451958], [1.681668686169194, 8.472736714557769], [2.054041204437417, 4.680031695721116], [3.1352641629535314, 5.810311903246376], [4.378200155159055, 8.429014740108636], [5.632843137254913, 16.43431372549023], [6.8013888888889005, 13.081481481481516], [50,100]]
    #actions = [[0.5000000000002669, 2.500000000000112], [0.7288428324698772, 4.0090056748083995], [1.1218344155846804, 3.0000000000002496], [1.2162849872773496, 7.4631043256997405], [1.4751902346226717, 3.9999999999997113], [1.749999999999973, 3.4999999999998117], [2.086678832116794, 6.2883211678832325], [2.193017888055368, 4.018753606462444], [2.2499999999999822, 7.500000000000021], [2.6328389830508536, 8.9762711864407], [2.980046948356806, 13.515845070422579], [3.2499999999999982, 5.500000000000034], [3.453852327447829, 11.505617977528125], [3.693027210884357, 6.0739795918367605], [4.000000000000004, 12.500000000000034], [4.151949541284411, 10.021788990825703], [4.752819548872187, 15.016917293233117], [4.8633603238866225, 7.977058029689605], [5.7367647058823605, 13.470588235294136], [6.071428571428564, 16.47435897435901], [6.408839779005503, 10.95488029465933], [7.837962962962951, 12.745370370370392], [8.772727272727282, 18.23295454545456], [9.242088607594926, 14.901898734177237], [100,200]]
   # actions = [[0.5000000000001132, 2.9999999999999174], [0.5000000000001159, 1.4999999999998659], [0.5011026964048937, 5.057090545938981], [0.5997656402578979, 1.9999999999999885], [0.7450101488498877, 2.500000000000264], [0.9957274202272546, 3.5038669551108814], [0.9986299023806298, 3.00000000000035], [0.9989438479141635, 6.000440063369089], [1.2502992817239085, 7.499301675977626], [1.3748807883861818, 5.499999999999963], [1.4714078698027613, 5.000000000000162], [1.6540920096852696, 4.3137046004844875], [1.7331017056222244, 8.988629185091602], [1.9997078301519378, 10.003506038176837], [2.131133083912334, 6.300320684126101], [2.2702554744525623, 7.199270072992672], [2.6956923890063442, 7.93093727977449], [2.9601038145823297, 8.740704973442782], [3.4156698564593317, 10.223684210526311], [4.180390032502709, 11.496208017334773], [4.475710508922673, 13.83311302048908], [5.686262376237629, 16.102103960396033], [7.189858490566042, 19.562500000000004], [9.489123012389175, 23.9905618964017], [100, 200]]
    #1-82013-2016#actions = [[1.0971083893545064, 12.780734874297824], [1.1227439921530564, 5.0000000000002025], [1.2335853575094577, 9.677591515566052], [1.2511041713139057, 15.999999999999872], [1.5038041133323725, 19.282755645045146], [1.686532170119944, 17.458312679686593], [1.9264175557936942, 7.2370125331967], [2.02304897137745, 5.627124329159388], [2.4325072358900095, 10.699589966232447], [2.5779913972888493, 13.130344108446305], [2.8119307692307682, 20.224307692307548], [2.852625298329354, 15.483160965261133], [3.2014590979045794, 9.185272877944676], [3.2373171223892623, 7.566037735848912], [3.6211730801830813, 22.306323105610964], [4.00415665989285, 11.104008867541099], [4.726152954808812, 20.078099652375336], [4.864921154418321, 12.499553704254689], [4.930584600760447, 17.123811787072206], [5.793574014481093, 14.29042638777153], [6.2467695620962, 23.51040918880109], [7.439736399326975, 19.99691531127306], [7.49569402228977, 17.16548463356975], [9.417529752331845, 23.923769700868746], [100, 2000]]
    #actions = [[0.5002033307514231, 9.999612703330783], [0.6802278275020894, 6.970301057770593], [1.1979313380281675, 14.240316901408438], [1.238262527233124, 11.421023965141616], [1.3402498377676804, 16.44159636599612], [1.4550034387895419, 22.414030261348046], [1.7906383921974274, 19.403576178513426], [1.8334690074539046, 6.07659866614364], [1.9509871600165671, 9.182797183487537], [1.9844808743169393, 5.00000000000005], [2.263022959183676, 7.842091836734736], [2.7651543942992896, 14.789548693586722], [3.1221539283805497, 16.213254943880298], [3.350909570261011, 12.044819404165569], [3.3748820754717013, 22.837853773584932], [3.5011228070175466, 6.6417543859649335], [3.6605886116442767, 9.704414587332057], [4.388342585249806, 8.21570182394924], [4.752295918367349, 14.082417582417579], [5.4250279329609, 17.403351955307247], [6.023128205128209, 23.252307692307696], [6.186773199845984, 11.237581825182907], [7.178633217993089, 15.37456747404844], [7.83320148331276, 20.010383189122425], [100, 2000]]
    #2015-2016_op 
    #actions =[[0.5, 10.0], [1.3000000000000007, 23.0], [1.3500000000000008, 6.0], [1.4000000000000008, 20.0], [1.600000000000001, 12.0], [1.6500000000000008, 16.0], [1.7500000000000009, 9.0], [1.8000000000000012, 9.0], [1.9000000000000008, 19.0], [1.9500000000000013, 5.0], [2.0000000000000013, 6.0], [2.1000000000000014, 9.0], [2.200000000000001, 6.0], [2.4000000000000017, 10.0], [2.650000000000002, 12.0], [2.7500000000000018, 15.0], [2.9000000000000017, 20.0], [3.3500000000000023, 16.0], [7.900000000000008, 20.0], [100, 2000]] # number of >800 label
    # number > 800
    #actions = [[0.5000000000000047, 9.999999999999966], [0.5876911076443143, 6.999999999999863], [0.8742723004694819, 18.711737089201883], [1.231789137380188, 5.999999999999997], [1.2728413068844713, 11.38302217036173], [1.3590389016018323, 14.336956521739136], [1.4000000000000008, 19.999999999999954], [1.4561853893866306, 22.41419710544441], [1.7218118582312023, 16.247432924809544], [1.73690727081138, 4.999999999999921], [1.784904714142428, 18.99999999999995], [1.8085359544749102, 8.000000000000005], [1.8508622147083686, 8.999999999999977], [1.8651748251748295, 7.000000000000005], [2.157863247863247, 5.9999999999998685], [2.493146677810282, 4.999999999999952], [2.783363576377437, 14.773012207192318], [2.89020866773676, 9.835072231139652], [2.8999999999999995, 20.000000000000007], [2.981865912762523, 11.999999999999998], [3.041631711409398, 16.2386744966443], [3.0622389306599844, 22.978279030910596], [3.1057039235080786, 7.556544675239042], [7.899999999999988, 19.999999999999844], [7.950000000000058, 18.999999999999858]] #number of 扣除300以下取kmeans
    #扣除number < 300 再娶kmeans
    #actions = [[1.5999999999999976, 12.0], [1.6023869346733706, 16.00000000000001], [1.650000000000003, 14.000000000000002], [1.7000000000000042, 10.999999999999996], [1.8102983638113537, 4.999999999999947], [1.8651748251748241, 6.999999999999981], [1.8903076923076965, 18.999999999999964], [1.9159746463347453, 8.99999999999996], [2.0846182085168903, 7.999999999999986], [2.1578632478632516, 5.999999999999929], [2.4000000000000004, 10.000000000000009], [2.432984073763622, 21.999999999999986], [2.493146677810282, 4.999999999999958], [2.5541284403669717, 14.99999999999998], [2.798565776458954, 13.999999999999996], [2.8770398172323786, 16.185704960835483], [2.9000000000000012, 19.999999999999982], [2.972463077656029, 8.195807527393972], [2.981865912762522, 12.0], [3.12335483870968, 23.510967741935488], [3.311895910780671, 6.999999999999978], [3.6239842726081277, 9.999999999999995], [3.8110011001100137, 14.598459845984598], [7.900000000000023, 19.999999999999925], [7.949999999999958, 18.99999999999993]]
    # 扣除 number < 300 and std <1.5 再取 kmeans
    actions = [[1.2051618958235566, 22.564054434537756], [1.2317891373801908, 6.0000000000000036], [1.3222769028871393, 11.0], [1.3590389016018345, 14.336956521739136], [1.4000000000000021, 20.000000000000007], [1.405788271134805, 12.000000000000004], [1.546812360801784, 7.1589643652561294], [1.5537195382642162, 16.319367250961953], [1.6838230972671162, 19.000000000000004], [1.8508622147083689, 9.000000000000005], [2.0293100662465666, 4.999999999999887], [2.1003714935557274, 5.999999999999912], [2.3602789699570814, 8.000000000000005], [2.4000000000000012, 10.000000000000004], [2.432984073763623, 22.000000000000004], [2.5256825938566547, 16.32366325369739], [2.5541284403669753, 15.000000000000004], [2.650000000000003, 12.000000000000002], [2.798565776458953, 14.000000000000004], [2.900000000000003, 20.000000000000007]]
    # 扣除 number < 300 and std <3 and std >1 再取 kmeans
    #print(actions[0][0])
    #Net = CNN_classsification1()
    #print(Net)
    
    Net = torch.load('2015-2016NewNew_wegiht_decay005_1231.pkl')
    Net.eval()
    #print(Net)
    whole_year = new_dataloader.test_data()
    whole_year = torch.FloatTensor(whole_year).cuda()
    #print(whole_year)
    torch_dataset_train = Data.TensorDataset(whole_year)
    whole_test = Data.DataLoader(
            dataset=torch_dataset_train,      # torch TensorDataset format
            batch_size = 1024,      # mini batch size
            shuffle = False,               
            )
    for step, (batch_x,) in enumerate(whole_test):
        #print(batch_x)
        output = Net(batch_x)               # cnn output
        _, predicted = torch.max(output, 1)
        action_choose = predicted.cpu().numpy()
        action_choose = action_choose.tolist()
        action_list.append(action_choose)
   # action_choose = predicted.cpu().numpy()
    action_list =sum(action_list, [])
    print(len(action_list))

    
    count_test = 0
    datelist = [f.split('_')[0] for f in os.listdir(path_to_2017compare)]
    #print(datelist[167:])
    profit_count = 0
    for date in sorted(datelist[:]): #決定交易要從何時開始
        table = pd.read_csv(path_to_2017compare+date+ext_of_compare)
        mindata = pd.read_csv(path_to_average+date+ext_of_average)
       # try:
        tickdata = pd.read_csv(path_to_minprice+date+ext_of_minprice)#.drop([266, 267, 268, 269, 270])
        #except:
         #   continue
        #halfmin = pd.read_csv(path_to_half+date+ext_of_half)
        #print(tickdata.shape)
        tickdata = tickdata.iloc[166:]
        tickdata.index = np.arange(0,len(tickdata),1)  
        num = np.arange(0,len(table),1)
        #print(date)
        for pair in num: #看table有幾列配對 依序讀入
            #action_choose = 0
            #try :
           #     spread =  table.w1[pair] * np.log(mindata[ str(table.stock1[pair]) ]) + table.w2[pair] * np.log(mindata[ str(table.stock2[pair]) ])
            ##    continue
            for i in range(20):
                if action_list[pair] == i :
                    open, loss = actions[i][0] ,1000#, actions[i][1] 
                    #open, loss = 1.5, 1000#
            if table.dtw_distance[pair] < 0.05 :
                profit,opennum,trade_capital,trading  = trading_period_by_gate_mean_new.pairs( pair ,166,  table , mindata , tickdata , open ,open, loss ,mindata, max_posion , 0.0015, 0.0015, 300000000 )
            #print(trading)
            if profit > 0 and opennum == 1 :
                profit_count +=1
                print("有賺錢的pair",profit)
                '''
                flag = os.path.isfile(path_to_profit+str(date)+'_profit.csv')
        
                if not flag :
                    df = pd.DataFrame({"stock1":[table.stock1[pair]],"stock2":[table.stock2[pair]],"trade_capital":[trade_capital],"open":[open],"loss":[loss],"reward":[profit],"open_num":[opennum]})
                    df.to_csv(path_to_profit+str(date)+'_profit.csv', mode='w',index=False)
                else :
                    df = pd.DataFrame({"stock1":[table.stock1[pair]],"stock2":[table.stock2[pair]],"trade_capital":[trade_capital],"open":[open],"loss":[loss],"reward":[profit],"open_num":[opennum]})
                    df.to_csv(path_to_profit+str(date)+'_profit.csv', mode='a', header=False,index=False)  
                '''
                
                
            elif opennum ==1 and profit < 0 :
                
                print("賠錢的pair :", profit)
                '''
                flag = os.path.isfile(path_to_profit+str(date)+'_profit.csv')
        
                if not flag :
                    df = pd.DataFrame({"stock1":[table.stock1[pair]],"stock2":[table.stock2[pair]],"trade_capital":[trade_capital],"open":[open],"loss":[loss],"reward":[profit],"open_num":[opennum]})
                    df.to_csv(path_to_profit+str(date)+'_profit.csv', mode='w',index=False)
                else :
                    df = pd.DataFrame({"stock1":[table.stock1[pair]],"stock2":[table.stock2[pair]],"trade_capital":[trade_capital],"open":[open],"loss":[loss],"reward":[profit],"open_num":[opennum]})
                    df.to_csv(path_to_profit+str(date)+'_profit.csv', mode='a', header=False,index=False) 
                
                '''
            #print("開倉次數 :",opennum)
 
            if opennum == 1 or opennum == 0:
                check += 1
                
            total_reward += profit            
            total_num += opennum
            count_test +=1
            total_trade[0] += trading[0]
            total_trade[1] += trading[1]
            total_trade[2] += trading[2]
            
            
    print("total :",check)        
            #print(count_test)
    print("利潤  and 開倉次數 and 開倉有賺錢的次數/開倉次數:",total_reward ,total_num, profit_count/total_num)
    print("開倉有賺錢次數 :",profit_count)
    print("正常平倉 停損平倉 強迫平倉 :",total_trade[0],total_trade[1],total_trade[2])
    
          
#test()